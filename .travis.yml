language: cpp
sudo: false
dist: trusty
matrix:
  include:
    - os: linux
      addons: &1
        apt:
          packages:
            - gfortran
            - python-dev
            - libblas-dev
            - liblapack-dev
            - libopenmpi-dev
            - openmpi-bin
            - libboost1.55-all-dev
            - libhdf5-openmpi-dev
            - uuid-dev
            - pkg-config
      env:
        - GENERATOR="Unix Makefiles"
        - BUILDFLAGS="VERBOSE=1"
    - os: linux
      addons: *1
      env:
        - GENERATOR="Ninja"
        - BUILDFLAGS="-v"
        - NINJA_URL="https://goo.gl/4g5Jjv"
    - os: osx
      env:
        - GENERATOR="Unix Makefiles"
        - BUILDFLAGS="VERBOSE=1"
    - os: osx
      env:
        - GENERATOR="Ninja"
        - BUILDFLAGS="-v"
        - NINJA_URL="https://goo.gl/qLgScp"

before_install:
  - test -n $CC && unset CC
  - test -n $CXX && unset CXX
  - test -n $FC && unset FC

install:
  - mkdir -p ${HOME}/Deps
  - DEPS=${HOME}/Deps
  - |
    # Install CMake 3.7.2 and Kitware-maintained version of Ninja
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then
      cd ${DEPS}
      mkdir -p cmake-3.7.2
      curl -L https://goo.gl/dSVHTh | tar -xz -C cmake-3.7.2 --strip-components=1
      export PATH=$PWD/cmake-3.7.2/bin:$PATH
      export LD_LIBARY_PATH=$PWD/cmake-3.7.2/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
      # Get Eigen
      curl -L http://bitbucket.org/eigen/eigen/get/3.3.4.tar.gz | tar xz
      cd eigen-eigen-5a0156e40feb
      cmake -H. -Bbuild_eigen -DCMAKE_INSTALL_PREFIX=${PWD}/eigen-3.3.4 >/dev/null 2>&1
      cmake --build build_eigen -- install >/dev/null 2>&1
      pip install --user virtualenv
      cd ${TRAVIS_BUILD_DIR}
    elif [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then
      # Install latest available CMake
      brew upgrade cmake
      # Get GFortran
      brew install gcc eigen boost mpich hdf5 pkg-config ossp-uuid
      # virtual environments
      pip install virtualenv
    fi
  - virtualenv venv
  - source venv/bin/activate
  - pip install -r requirements.txt
  - |
    if [[ "${GENERATOR}" == "Ninja" ]]; then
      cd ${DEPS}
      mkdir -p ninja-1.7.2
      curl -L ${NINJA_URL} | tar -xz -C ninja-1.7.2 --strip-components=1
      export PATH=$PWD/ninja-1.7.2:$PATH
      cd ${TRAVIS_BUILD_DIR}
    fi

before_script:
  - ./.scripts/report_versions.sh

script:
  - python .scripts/ci_configure_build_test.py 'Chapter*/recipe-*'
